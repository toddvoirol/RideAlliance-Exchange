<div class="admin-module">
  <div *ngIf="showGrid" class="data-view">
    <!-- Users List View -->
    <h2 class="section-title">{{ 'USERS.TITLE' | translate }}</h2>

    <div class="action-bar">
      <!-- <div class="search-container">
        <div class="search-input-wrapper">
          <i class="ph ph-magnifying-glass" aria-hidden="true"></i>
          <input
            #gb
            type="text"
            class="search-input"
            pInputText
            placeholder="{{ 'USERS.SEARCH_PLACEHOLDER' | translate }}"
            [attr.aria-label]="'USERS.SEARCH_ARIA' | translate"
          />
        </div>
      </div> -->

      <div class="action-buttons">
        <button
          class="btn-primary"
          (click)="addUser()"
          [attr.aria-label]="'USERS.ADD_USER_ARIA' | translate"
        >
          <i class="ph ph-plus" aria-hidden="true"></i>
          <span>{{ 'USERS.ADD_USER' | translate }}</span>
        </button>
      </div>
    </div>

    <div class="data-table-container">
      <p-table
        [value]="userListData"
        styleClass="p-datatable-sm"
        [sortMode]="'multiple'"
        [rows]="7"
        [paginator]="true"
        [globalFilterFields]="['name', 'providerName', 'jobTitle', 'email', 'phoneNumber']"
        [reorderableColumns]="true"
        [resizableColumns]="true"
      >
        <!--
        <ng-template pTemplate="caption">
          <div class="table-header">
            <span class="search-input-container">
              <i class="ph ph-magnifying-glass"></i>
              <input
                type="text"
                pInputText
                #gb
                (input)="filterGlobal($event)"
                placeholder="{{ 'USERS.SEARCH_PLACEHOLDER' | translate }}"
                [attr.aria-label]="'USERS.SEARCH_ARIA' | translate"
              />
            </span>
          </div>
        </ng-template>
-->
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="name" class="column-name">
              {{ 'USERS.NAME' | translate }} <p-sortIcon field="name"></p-sortIcon>
            </th>
            <th pSortableColumn="providerName" class="column-provider">
              {{ 'USERS.PROVIDER' | translate }} <p-sortIcon field="providerName"></p-sortIcon>
            </th>
            <th pSortableColumn="jobTitle" class="column-title">
              {{ 'USERS.TITLE_FIELD' | translate }} <p-sortIcon field="jobTitle"></p-sortIcon>
            </th>
            <th pSortableColumn="email" class="column-email">
              {{ 'USERS.EMAIL' | translate }} <p-sortIcon field="email"></p-sortIcon>
            </th>
            <th pSortableColumn="phoneNumber" class="column-phone">
              {{ 'USERS.PHONE' | translate }} <p-sortIcon field="phoneNumber"></p-sortIcon>
            </th>
            <th class="column-actions">{{ 'USERS.ACTIONS' | translate }}</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-user>
          <tr>
            <td class="column-name">{{user.name}}</td>
            <td class="column-provider">{{user.providerName}}</td>
            <td class="column-title">{{user.jobTitle}}</td>
            <td class="column-email">
              <a href="mailto:{{user.email}}" class="email-link">{{user.email}}</a>
            </td>
            <td class="column-phone">{{user.phoneNumber}}</td>
            <td class="column-actions">
              <div class="action-icons">
                <button
                  class="btn-icon btn-edit"
                  [title]="'USERS.EDIT_USER_TITLE' | translate"
                  [attr.aria-label]="'USERS.EDIT_USER_ARIA' | translate"
                  (click)="editUser(user)"
                  style="margin-right: 8px"
                >
                  <i class="ph ph-pencil-simple"></i>
                </button>

                <button
                  class="btn-icon"
                  [ngClass]="{'btn-success': !user.isActive, 'btn-danger': user.isActive}"
                  [title]="(user.isActive ? 'USERS.DEACTIVATE_TITLE' : 'USERS.ACTIVATE_TITLE') | translate"
                  [attr.aria-label]="(user.isActive ? 'USERS.DEACTIVATE_ARIA' : 'USERS.ACTIVATE_ARIA') | translate"
                  (click)="updateStatus(user)"
                >
                  <i
                    class="ph"
                    [ngClass]="{'ph-check-circle': !user.isActive, 'ph-x-circle': user.isActive}"
                  ></i>
                </button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6">
              <div class="empty-message">
                <i class="ph ph-info"></i>
                <span>{{ 'USERS.NO_RECORDS' | translate }}</span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Add/Edit User Form -->
  <div *ngIf="!showGrid" class="form-view">
    <div class="form-container">
      <h2 class="form-title">{{pageName}} {{ 'USERS.USER' | translate }}</h2>

      <form novalidate #userForm="ngForm" class="data-form user-form">
        <div class="form-section">
          <div class="form-row">
            <div class="form-group">
              <label for="email" class="form-label">
                {{ 'USERS.EMAIL_REQUIRED' | translate }} <span class="required-indicator">*</span>
              </label>
              <input
                type="email"
                id="email"
                class="form-control"
                [(ngModel)]="user.email"
                name="email"
                [required]="true"
                maxlength="100"
                #email="ngModel"
                pattern="[^@]+@[^@]+\.[a-zA-Z]{2,}"
                [ngClass]="{'invalid-input': !email.valid && !email.pristine}"
                aria-describedby="email-error"
              />
              <div id="email-error" class="error-message" *ngIf="!email.valid && !email.pristine">
                {{ 'USERS.VALID_EMAIL_ERROR' | translate }}
              </div>
            </div>

            <div class="form-group">
              <label for="name" class="form-label">
                {{ 'USERS.NAME_REQUIRED' | translate }} <span class="required-indicator">*</span>
              </label>
              <input
                type="text"
                id="name"
                class="form-control"
                [(ngModel)]="user.name"
                name="name"
                [required]="true"
                maxlength="100"
                pattern="[A-Za-z ]{1,100}"
                #name="ngModel"
                [ngClass]="{'invalid-input': !name.valid && !name.pristine}"
                aria-describedby="name-error"
              />
              <div id="name-error" class="error-message" *ngIf="!name.valid && !name.pristine">
                {{ 'USERS.VALID_NAME_ERROR' | translate }}
              </div>
            </div>

            <div class="form-group">
              <label for="jobTitle" class="form-label">
                {{ 'USERS.TITLE_REQUIRED' | translate }} <span class="required-indicator">*</span>
              </label>
              <input
                type="text"
                id="jobTitle"
                class="form-control"
                [(ngModel)]="user.jobTitle"
                name="jobTitle"
                [required]="true"
                maxlength="30"
                pattern="[A-Za-z0-9 ]{1,100}"
                #jobTitle="ngModel"
                [ngClass]="{'invalid-input': !jobTitle.valid && !jobTitle.pristine}"
                aria-describedby="jobTitle-error"
              />
              <div
                id="jobTitle-error"
                class="error-message"
                *ngIf="!jobTitle.valid && !jobTitle.pristine"
              >
                {{ 'USERS.VALID_TITLE_ERROR' | translate }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="phoneNumber" class="form-label">
                {{ 'USERS.PHONE_REQUIRED' | translate }} <span class="required-indicator">*</span>
              </label>
              <p-inputMask
                id="phoneNumber"
                [(ngModel)]="user.phoneNumber"
                name="phoneNumber"
                [required]="true"
                mask="(999) 999-9999"
                styleClass="form-control"
                pattern="^\([1-9][0-9]{2}\)[ ]([0-9]{3})[-]([0-9]{4})"
                #phoneNumber="ngModel"
                [ngClass]="{'invalid-input': !phoneNumber.valid && !phoneNumber.pristine}"
                aria-describedby="phoneNumber-error"
              >
              </p-inputMask>
              <div
                id="phoneNumber-error"
                class="error-message"
                *ngIf="!phoneNumber.valid && !phoneNumber.pristine"
              >
                {{ 'USERS.VALID_PHONE_ERROR' | translate }}
              </div>
            </div>

            <div class="form-group" *ngIf="pageName === 'Add'">
              <label for="provider" class="form-label">
                {{ 'USERS.PROVIDER_REQUIRED' | translate }}
                <span class="required-indicator">*</span>
              </label>
              <select
                id="provider"
                class="form-select"
                [(ngModel)]="user.providerId"
                name="provider"
                [required]="true"
                pattern="[0-9 ]{1,100}"
                #provider="ngModel"
                [ngClass]="{'invalid-input': !provider.valid && !provider.pristine}"
                aria-describedby="provider-error"
              >
                <option value="">{{ 'USERS.PLEASE_SELECT' | translate }}</option>
                <option *ngFor="let provider of providersList" [value]="provider.providerId">
                  {{provider.providerName}}
                </option>
              </select>
              <div
                id="provider-error"
                class="error-message"
                *ngIf="!provider.valid && !provider.pristine"
              >
                {{ 'USERS.VALID_PROVIDER_ERROR' | translate }}
              </div>
            </div>

            <div class="form-group" *ngIf="pageName === 'Edit'">
              <label for="provider-disabled" class="form-label">
                {{ 'USERS.PROVIDER_REQUIRED' | translate }}
                <span class="required-indicator">*</span>
              </label>
              <select
                id="provider-disabled"
                class="form-select disabled"
                [(ngModel)]="user.providerId"
                name="provider"
                [required]="true"
                pattern="[0-9 ]{1,100}"
                #provider="ngModel"
                [ngClass]="{'invalid-input': !provider.valid && !provider.pristine}"
                [disabled]="true"
                aria-describedby="provider-error"
              >
                <option value="">{{ 'USERS.PLEASE_SELECT' | translate }}</option>
                <option *ngFor="let provider of providersList" [value]="provider.providerId">
                  {{provider.providerName}}
                </option>
              </select>
              <div
                id="provider-error"
                class="error-message"
                *ngIf="!provider.valid && !provider.pristine"
              >
                {{ 'USERS.VALID_PROVIDER_ERROR' | translate }}
              </div>
            </div>

            <div class="form-group">
              <label for="position" class="form-label">
                {{ 'USERS.ROLE_REQUIRED' | translate }} <span class="required-indicator">*</span>
              </label>
              <select
                id="position"
                class="form-select"
                [(ngModel)]="user.userRole"
                name="position"
                [required]="true"
                #position="ngModel"
                [ngClass]="{'invalid-input': !position.valid && !position.pristine}"
                aria-describedby="position-error"
              >
                <option value="">{{ 'USERS.PLEASE_SELECT' | translate }}</option>
                <option *ngFor="let role of rolesList" [value]="role.roleName | uppercase">{{ role.roleName }}</option>
              </select>
              <div
                id="position-error"
                class="error-message"
                *ngIf="!position.valid && !position.pristine"
              >
                {{ 'USERS.VALID_ROLE_ERROR' | translate }}
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3 class="section-subtitle">{{ 'USERS.EMAIL_NOTIFICATIONS' | translate }}</h3>
          <p class="section-description">{{ 'USERS.NOTIFICATIONS_DESC' | translate }}</p>

          <div class="section-controls" style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
            <button
              type="button"
              class="btn-secondary"
              (click)="toggleNotifications()"
              [attr.aria-label]="notifyAllSelected ? 'Deselect all notifications' : 'Select all notifications'"
            >
              <i class="ph" [ngClass]="notifyAllSelected ? 'ph-square' : 'ph-check-square'"></i>
              <span style="margin-left:6px">{{ notifyAllSelected ? 'Deselect all' : 'Select all' }}</span>
            </button>
          </div>

          <div class="checkbox-grid">
            <div class="form-checkbox">
              <input
                id="isNotifyPartnerCreatesTicket"
                type="checkbox"
                name="isNotifyPartnerCreatesTicket"
                [value]="true"
                [(ngModel)]="user.isNotifyPartnerCreatesTicket"
              />
              <label for="isNotifyPartnerCreatesTicket" class="checkbox-label">
                {{ 'USERS.NOTIFY_PARTNER_CREATES' | translate }}
              </label>
            </div>

            <div class="form-checkbox">
              <input
                id="isNotifyTripResultSubmitted"
                type="checkbox"
                name="isNotifyTripResultSubmitted"
                [value]="true"
                [(ngModel)]="user.isNotifyTripResultSubmitted"
              />
              <label for="isNotifyTripResultSubmitted" class="checkbox-label">
                {{ 'USERS.NOTIFY_RESULT_SUBMITTED' | translate }}
              </label>
            </div>

            <div class="form-checkbox">
              <input
                id="isNotifyPartnerUpdateTicket"
                type="checkbox"
                name="isNotifyPartnerUpdateTicket"
                [value]="true"
                [(ngModel)]="user.isNotifyPartnerUpdateTicket"
              />
              <label for="isNotifyPartnerUpdateTicket" class="checkbox-label">
                {{ 'USERS.NOTIFY_PARTNER_UPDATES' | translate }}
              </label>
            </div>

            <div class="form-checkbox">
              <input
                id="isNotifyTripCancelled"
                type="checkbox"
                name="isNotifyTripCancelled"
                [value]="true"
                [(ngModel)]="user.isNotifyTripCancelled"
              />
              <label for="isNotifyTripCancelled" class="checkbox-label">
                {{ 'USERS.NOTIFY_TRIP_CANCELLED' | translate }}
              </label>
            </div>


            <div class="form-checkbox">
              <input
                id="isNotifyNewTripClaimAutoApproved"
                type="checkbox"
                name="isNotifyNewTripClaimAutoApproved"
                [value]="true"
                [(ngModel)]="user.isNotifyNewTripClaimAutoApproved"
              />
              <label for="isNotifyNewTripClaimAutoApproved" class="checkbox-label">
                {{ 'USERS.NOTIFY_NEW_CLAIM_AUTO' | translate }}
              </label>
            </div>

            <div class="form-checkbox">
              <input
                id="isNotifyTripExpired"
                type="checkbox"
                name="isNotifyTripExpired"
                [value]="true"
                [(ngModel)]="user.isNotifyTripExpired"
              />
              <label for="isNotifyTripExpired" class="checkbox-label">
                {{ 'USERS.NOTIFY_TRIP_EXPIRED' | translate }}
              </label>
            </div>



            <div class="form-checkbox">
              <input
                id="isNotifyTripClaimApproved"
                type="checkbox"
                name="isNotifyTripClaimApproved"
                [value]="true"
                [(ngModel)]="user.isNotifyTripClaimApproved"
              />
              <label for="isNotifyTripClaimApproved" class="checkbox-label">
                {{ 'USERS.NOTIFY_CLAIM_APPROVED' | translate }}
              </label>
            </div>

            <div class="form-checkbox">
              <input
                id="isNotifyTripWeeklyReport"
                type="checkbox"
                name="isNotifyTripWeeklyReport"
                [value]="true"
                [(ngModel)]="user.isNotifyTripWeeklyReport"
              />
              <label for="isNotifyTripWeeklyReport" class="checkbox-label">
                {{ 'USERS.NOTIFY_WEEKLY_REPORT' | translate }}
              </label>
            </div>


            <div class="form-checkbox">
              <input
                id="isNotifyTripClaimDeclined"
                type="checkbox"
                name="isNotifyTripClaimDeclined"
                [value]="true"
                [(ngModel)]="user.isNotifyTripClaimDeclined"
              />
              <label for="isNotifyTripClaimDeclined" class="checkbox-label">
                {{ 'USERS.NOTIFY_CLAIM_DECLINED' | translate }}
              </label>
            </div>

            <div class="form-checkbox">
              <input
                id="isNotifyTripClaimCancelled"
                type="checkbox"
                name="isNotifyTripClaimCancelled"
                [value]="true"
                [(ngModel)]="user.isNotifyTripClaimCancelled"
              />
              <label for="isNotifyTripClaimCancelled" class="checkbox-label">
                {{ 'USERS.NOTIFY_TRIP_CLAIM_CANCELLED' | translate }}
              </label>
            </div>

            <div class="form-checkbox">
              <input
                id="isNotifyTripCommentAdded"
                type="checkbox"
                name="isNotifyTripCommentAdded"
                [value]="true"
                [(ngModel)]="user.isNotifyTripCommentAdded"
              />
              <label for="isNotifyTripCommentAdded" class="checkbox-label">
                {{ 'USERS.NOTIFY_COMMENT_ADDED' | translate }}
              </label>
            </div>



            <div class="form-checkbox">
              <input
                id="isNotifyTripClaimRescinded"
                type="checkbox"
                name="isNotifyTripClaimRescinded"
                [value]="true"
                [(ngModel)]="user.isNotifyTripClaimRescinded"
              />
              <label for="isNotifyTripClaimRescinded" class="checkbox-label">
                {{ 'USERS.NOTIFY_CLAIM_RESCINDED' | translate }}
              </label>
            </div>
<!--

-->

<!--
            <div class="form-checkbox">
              <input
                id="isNotifyTripReceived"
                type="checkbox"
                name="isNotifyTripReceived"
                [value]="true"
                [(ngModel)]="user.isNotifyTripReceived"
              />
              <label for="isNotifyTripReceived" class="checkbox-label">
                {{ 'USERS.NOTIFY_TRIP_RECEIVED' | translate }}
              </label>
            </div>
-->


<!--
            <div class="form-checkbox">
              <input
                id="isNotifyClaimedTicketRescinded"
                type="checkbox"
                name="isNotifyClaimedTicketRescinded"
                [value]="true"
                [(ngModel)]="user.isNotifyClaimedTicketRescinded"
              />
              <label for="isNotifyClaimedTicketRescinded" class="checkbox-label">
                {{ 'USERS.NOTIFY_CLAIMED_RESCINDED' | translate }}
              </label>
            </div>

            <div class="form-checkbox">
              <input
                id="isNotifyClaimedTicketExpired"
                type="checkbox"
                name="isNotifyClaimedTicketExpired"
                [value]="true"
                [(ngModel)]="user.isNotifyClaimedTicketExpired"
              />
              <label for="isNotifyClaimedTicketExpired" class="checkbox-label">
                {{ 'USERS.NOTIFY_CLAIMED_EXPIRED' | translate }}
              </label>
            </div>

            <div class="form-checkbox">
              <input
                id="isNotifyNewTripClaimAwaitingApproval"
                type="checkbox"
                name="isNotifyNewTripClaimAwaitingApproval"
                [value]="true"
                [(ngModel)]="user.isNotifyNewTripClaimAwaitingApproval"
              />
              <label for="isNotifyNewTripClaimAwaitingApproval" class="checkbox-label">
                {{ 'USERS.NOTIFY_NEW_CLAIM_AWAITING' | translate }}
              </label>
            </div>
-->



<!--
            <div class="form-checkbox">
              <input
                id="isNotifyTripPriceMismatched"
                type="checkbox"
                name="isNotifyTripPriceMismatched"
                [value]="true"
                [(ngModel)]="user.isNotifyTripPriceMismatched"
              />
              <label for="isNotifyTripPriceMismatched" class="checkbox-label">
                {{ 'USERS.NOTIFY_PRICE_MISMATCHED' | translate }}
              </label>
            </div>
-->

          </div>
        </div>

        <div class="form-actions">
          <button
            type="button"
            class="btn-secondary"
            (click)="cancelEdit()"
            [attr.aria-label]="'USERS.CANCEL_ARIA' | translate"
          >
            {{ 'USERS.CANCEL' | translate }}
          </button>
          <button
            type="button"
            class="btn-primary"
            (click)="addEditUser(user)"
            [disabled]="!isFormValid()"
            [attr.aria-label]="(pageName === 'Add' ? 'USERS.SAVE_USER_ARIA' : 'USERS.UPDATE_USER_ARIA') | translate"
          >
            {{ pageName === 'Add' ? ('USERS.SAVE' | translate) : ('USERS.UPDATE' | translate) }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
